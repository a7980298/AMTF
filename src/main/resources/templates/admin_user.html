<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8"/>
<title>人员管理页面</title>
<th:block th:replace="vue-import :: vue-import"></th:block>
<style type="text/css">
	.colorSuccess{
		color: #07bf07;
	}
	.d-none{
		display: none;
	}
</style>
<body class="">
	<div class="wrapper" id="admin_id">
		<i-form class="" th:action="@{/f020003}" method="post" style="height:100%;" id="amtf_form" enctype="multipart/form-data">
			<input type="hidden" name="IViewId" value="f020001"/>
			<div id="app">
				<el-container>
					<th:block th:replace="admin_navbar :: admin_navbar"></th:block>
					<el-main style="padding-top: 0px">
						<th:block th:replace="admin_head :: admin_head"></th:block>
						<!--
							:data -> data.user_name.toLowerCase().includes(search.toLowerCase()) ->将输入框模糊匹配user_name的值
						-->
						<el-table
								:data="tableData.filter(data => !search || data.user_name.toLowerCase().includes(search.toLowerCase()) || data.user_account.toLowerCase().includes(search.toLowerCase()))"
								:style="tableData.length > 12 ? 'width: 100%;height=800' : 'width: 100%;'"
								v-loading="loading"
								:cell-class-name="getCellClass">
							<el-table-column
									type="selection"
									width="55">
							</el-table-column>
							<el-table-column
									label="账户"
									width="180">
								<template slot-scope="scope">
									<span style="margin-left: 10px">{{ scope.row.user_account }}</span>
								</template>
							</el-table-column>
							<el-table-column
									label="姓名"
									width="180">
								<template slot-scope="scope">
									<el-popover trigger="hover" placement="top">
										<p>姓名: {{ scope.row.user_name }}</p>
										<p>电话: {{ scope.row.user_phone }}</p>
										<p>邮箱: {{ scope.row.user_email }}</p>
										<div slot="reference" class="name-wrapper">
											<el-tag size="medium" v-bind:id="'userNameId' + scope.$index">{{ scope.row.user_name }}</el-tag>
										</div>
									</el-popover>
								</template>
							</el-table-column>
							<el-table-column
									prop="tag"
									label="认证"
									width="180"
									:filters="[{ text: '已认证', value: '1' }, { text: '未认证', value: '0' }]"
									:filter-method="filterAttestation "
									filter-placement="bottom-end">
								<template slot-scope="scope">
									<span style="margin-left: 10px" :class="scope.row.user_attestation == '0' ? '' : 'colorSuccess'" v-if="scope.row.user_attestation == '0'">未认证</span>
									<span style="margin-left: 10px" :class="scope.row.user_attestation == '0' ? '' : 'colorSuccess'" v-if="scope.row.user_attestation != '0'">已认证</span>
									<el-popconfirm
											confirm-button-text='确定'
											cancel-button-text='取消'
											icon="el-icon-info"
											icon-color="red"
											title="当前是认证状态，确定修改-未认证-吗？"
											:class="scope.row.user_attestation == '0' ? 'd-none' : ''"
											@confirm="modificationStatusConfirmation(scope.$index, scope.row)">
										<el-button icon="el-icon-check" type="success" slot="reference" circle @click="certificationStatus(scope.$index, scope.row)" size="mini"></el-button>
									</el-popconfirm>
									<el-button icon="el-icon-close" type="info" :class="scope.row.user_attestation == '1' ? 'd-none' : ''" circle @click="certificationStatus(scope.$index, scope.row)" size="mini"></el-button>
								</template>
							</el-table-column>
							<el-table-column
									label="住址"
									width="180">
								<template slot-scope="scope">
									<span style="margin-left: 10px">{{ scope.row.user_country }}-{{scope.row.user_province}}-{{scope.row.user_city}}</span>
								</template>
							</el-table-column>
							<el-table-column
									label="权限"
									width="180">
								<template slot-scope="scope">
									<span style="margin-left: 10px" v-if="scope.row.user_power == '0'">普通用户</span>
									<span style="margin-left: 10px" v-if="scope.row.user_power != '0'">管理员</span>
								</template>
							</el-table-column>
							<el-table-column label="操作">
								<template slot-scope="scope">
									<el-button
											size="small"
											@click="editUser(scope.$index, scope.row)">编辑</el-button>
									<el-button
											size="small"
											@click="viewUserInformation(scope.$index, scope.row)">查看</el-button>
								</template>
							</el-table-column>
							<el-table-column
									align="right">
								<template slot="header" slot-scope="scope">
									<el-input
											v-model="search"
											size="mini"
											placeholder="输入关键字搜索"/>
								</template>
							</el-table-column>
						</el-table>
						<div style="margin-top: 20px">
							<el-button type="primary" @click="toggleSelection()">选中-认证</el-button>
						</div>
						<el-dialog
								title="基本信息"
								:visible.sync="dialogVisible"
								width="30%"
								:before-close="handleClose">
							<el-row :gutter="20">
								<el-col :span="5">
									<div class="block">
										<div class="block">
											<el-avatar :size="80" :src="dialog.src"></el-avatar>
											<el-link type="primary" :click="goToHomepage">进入TA的主页</el-link>
										</div>
									</div>
								</el-col>
								<el-col :span="19">
									<el-row>
										<el-col :span="24">
											<span>姓名：{{dialog.name}}</span>
										</el-col>
									</el-row>
									<el-row>
										<el-col :span="24">
											<span>邮箱：{{dialog.email}}</span>
										</el-col>
									</el-row>
									<el-row>
										<el-col :span="24">
											<span>座右铭：{{dialog.userIntroduce}}</span>
										</el-col>
									</el-row>
									<el-row>
										<el-col :span="8">
											<span>参加的活动：{{dialog.numberOfActivities}}</span>
										</el-col>
										<el-col :span="8">
											<span>发布的问题：{{dialog.numberOfQuestions}}</span>
										</el-col>
										<el-col :span="8">
											<span>发布的视频：{{dialog.numberOfVideo}}</span>
										</el-col>
									</el-row>
								</el-col>
							</el-row>
							<span slot="footer" class="dialog-footer">
								<!--<el-button @click="dialogVisible = false">取 消</el-button>-->
								<el-button type="primary" @click="dialogVisible = false">确 定</el-button>
							</span>
						</el-dialog>
					</el-main>

				</el-container>
			</div>
		</i-form>
	</div>
</body>
<script type="text/javascript">
	new Vue({
		el: '#admin_id',
		data: {
			tableData:'',
			dialogVisible:false,
			userNameId:'',
			search: '',
			dialog:{
				name:'',
				src:'',
				email:'',
				userIntroduce:'',
				numberOfActivities:'',
				numberOfQuestions:'',
				numberOfVideo:''
			}
		},
		methods: {
			//用户基本信息
			viewUserInformation(idx,row) {
				if(this.tableData[idx].user_path == ''){
					this.dialog.src = '/amtf/imgs/userimg.jpg';
				} else {
					this.dialog.src = '/amtf/istatic/' + this.tableData[idx].user_path;
				}
				//姓名
				this.dialog.name = this.tableData[idx].user_name;
				//邮箱
				this.dialog.email = this.tableData[idx].user_email;
				//获取基本信息
				axios.post('/amtf/Vf020001/getUser',{
					userId:this.tableData[idx].user_email
				}).then(response => {
					if(response.message != '' && response.data != null){
						this.Message('error',response.data.message);
					} else {
						//自我介绍
						if(response.data.userHistory.userIntroduce != ''){
							this.dialog.userIntroduce = response.data.userHistory.userIntroduce;
						}
						//参加活动次数
						this.dialog.numberOfActivities = response.data.userHistory.numberOfActivities;
						//发布问题次数
						this.dialog.numberOfQuestions = response.data.userHistory.numberOfQuestions;
						//发布视频次数
						this.dialog.numberOfVideo = response.data.userHistory.numberOfVideo;
						//打开模态框
						this.dialogVisible = true;
					}
				})
			},
			//编辑用户
			editUser(idx,row){
				this.userNameId = 'userNameId' + idx;

			},
			modificationStatusConfirmation(idx, row){
				if(row.user_attestation == '1'){
					this.upAttestation(this.tableData[idx].user_email, '0', row);
				}
			},
			//用户主页
			goToHomepage(){

			},
			//修改认证状态
			certificationStatus(idx, row){
				if(row.user_attestation == '0'){
					this.upAttestation(this.tableData[idx].user_email, '1', row);
				}
			},
			//认证状态修改axios
			upAttestation(userid, userAttestation, row){
				axios.post('/amtf/Vf020001/upattestation',{
					userId:userid,
					userAttestation:userAttestation
				}).then(response => {
					if(response.message != '' && response.message != null){
						this.Message('error',response.data.message);
					} else {
						row.user_attestation = userAttestation;
					}
				})
			},
			// 消息框
			Message(type,message) {
				if(type == 'error'){
					this.$message.error(message);
				} else {
					this.$message({
						message: message,
						type: type
					});
				}
			},
			//筛选
			filterAttestation(value, row){
				return row.user_attestation === value;
			}
		},
		//初期化获取数据
		created()
		{
			axios.post('/amtf/Vf020001').then(response => {
				//绑定数据
				this.tableData = response.data.select1;
			})
		}
	})
</script>
</html>